#!/usr/bin/env ruby

require 'rubygems'
require 'ruby-debug'
$:.unshift File.join(File.dirname(__FILE__), *%w[.. lib])

help = <<HELP
Mr. Hyde is a companion application for Jekyll
HELP

require 'mrhyde'
options = {}

opts = OptionParser.new do |opts|
  opts.banner = help
  
  opts.on("--server [PORT]", "Start web server (default port 4000)") do |port|
    options['server'] = true
    options['server_port'] = port unless port.nil?
  end
    
  opts.on("--rackup [DIR]", "Generates a default rackup file") do |directory|
    options['rackup'] = true
    options['rackup_directory'] = directory unless directory.nil?
  end
  
  opts.on("--templates-directory DIR", "Defines the directory holding login/comment templates") do |directory|
    options['templates_directory'] = directory
  end
end

opts.parse!

if options.keys.empty?
  puts "Run `mrhyde --help` for options" 
  exit(1)
end

options['mongoid_port'] = 27017 unless options['mongoid_port']

if options['templates_directory'].nil?
  puts "Using Default Templates. You can specify a templates directory with --templates-directory DIR"
end

Main.set :run, options['server']
Main.set :port, options['server_port'] if options['server_port']
Main.set :root, options['templates_directory'] if options['templates_directory'].nil?

Mongoid.configure do |config|
  name = "mrhyde_comments"
  config.master = Mongo::Connection.new('localhost', options['mongoid_port']).db(name)
end

begin
  MrHyde::Comment.all.count
  Main.run! if Main.run?
rescue
  puts "ERROR: Please ensure your MongoDB server is running."
end
