#!/usr/bin/env ruby

$:.unshift File.join(File.dirname(__FILE__), *%w[.. lib])

help = <<HELP
Mr. Hyde is a companion application for Jekyll
HELP

require 'optparse'
options = {}

opts = OptionParser.new do |opts|
  opts.banner = help
  
  opts.on("--server [PORT]", "Start web server (default port 4000)") do |port|
    options['server'] = true
    options['server_port'] = port unless port.nil?
  end
  
  opts.on("--disable-github", "Disables github hooks") do
    options['github'] = false
  end
    
  opts.on("--rackup [DIR]", "Generates the rackup file") do |directory|
    options['rackup'] = true
    options['rackup_directory'] = directory unless directory.nil?
  end
  
  opts.on("--start-redis [PORT]", "Starts the required redis server") do |port|
    options['redis'] = true
    options['redis_port'] = port unless port.nil?
  end
  
  opts.on("--rpx-key KEY", "Defines the RPX API key for logins") do |rpx_key|
    options['rpx_key'] = rpx_key
  end
end

opts.parse!

if options.keys.empty?
  puts "Run `mrhyde --help` for options" 
  exit(1)
end

options['github'] = true unless options['github']
options['redis_port'] = 6379 unless options['redis_port']

if options['rpx_key'].nil?
  puts "Please specify your RPX key for logging in with --rpx-key"
end

require 'sinatra/base'

class Main < Sinatra::Base
  enable :dump_errors, :logging, :static
  
  set :app_file, File.join(File.dirname(__FILE__), "..", "lib", "mrhyde.rb")
  set :root, File.join(File.dirname(__FILE__), "..", "lib", "mrhyde")
  set :environment, :development
  use Rack::Session::Cookie
  
  def self.rpx
    @@rpx ||= Evri::RPX::Session.new(options.rpx_key)
  end
end

Main.set :run, options['server']
Main.set :rpx_key, options['rpx_key']

require 'mrhyde'